<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Publishing my first npm package</title>
<meta name="viewport" content="width=device-width">
<meta name="description" content="I use a lot of great open source software every day. For both work and side projects. Although I have released everything I&#x27;ve ever made on GitHub, I...">
<link rel="canonical" href="https://davidxmoody.com/publishing-my-first-npm-package/">
<link rel="stylesheet" href="/css/main-a224372f29b28b5918ba7d3053ef3cc9.css">
<meta name="wot-verification" content="fdff4a26070b9df2fd1a" />
</head>

<body>

<div class="wrapper">
<header class="site-header">
<h1><a href="/">David Moody</a></h1>
<p>A blog about programming</p>
</header>

<div class="content">
<article>
<header>
<h1>Publishing my first npm package</h1>
<p><em>May 26, 2015</em></p>
</header>
<div>
<p>I use a lot of great open source software every day. For both work and side projects. </p>
<p>Although I have released everything I&#39;ve ever made on <a href="https://github.com/davidxmoody">GitHub</a>, I had never created anything which other people could <em>actually use</em>.</p>
<p>I wanted to change that. This is the story of how I published my <a href="https://www.npmjs.com/package/metalsmith-broken-link-checker">first npm package</a> and what I learned along the way.</p>
<!--more-->
<h2 id="the-problem-i-wanted-to-solve">The problem I wanted to solve</h2>
<p>I&#39;ve been using <a href="http://www.metalsmith.io/">Metalsmith</a> for a while now. It&#39;s a very simple static site generator which uses plugins to do most of the hard work. I wrote a blog post on <a href="/building-a-blog-with-metalsmith/">how I built this blog with it</a>. I have also been using it to build a very large static site at my new job (which I will write about later). </p>
<p>Sometimes, you can end up with broken links between the pages of your site. By &quot;broken link&quot;, I mean a link to another page on your site which does not exist. They can be caused by simple typos or more complex bugs.</p>
<p>With static sites, every single page is generated before you deploy your site. This makes it possible to check all internal links for references to missing pages.</p>
<p>Thus, I decided to create a Metalsmith plugin to help developers catch broken links as soon as possible.</p>
<h2 id="plan-of-action">Plan of action</h2>
<p>Before I started on this plugin, I checked to see if anything like it already existed. There are several libraries meant to check live websites sites for external URLs. However, <em>that&#39;s not what I wanted</em>. I wanted something to check internal relative and root-relative links within a static site <em>before</em> it has been deployed.</p>
<p>The main requirement of a project like this is that it actually works <em>correctly</em>. That means tests. </p>
<p>It&#39;s an awkward thing to test because Metalsmith runs asynchronously and the only output should be the presence or absence of an error. I used <a href="http://mochajs.org/">Mocha</a> and <a href="http://chaijs.com/">Chai</a> to run my tests. I then created a set of Metalsmith source files such that removing any one file would break an internal link. I then looped through, deleting one file at a time and expecting an error to be thrown in each case.</p>
<p>I&#39;ve written tests before but I have to say I&#39;ve never found them as useful as with this project. This time, I actually used my tests as the main method for developing my plugin. I always kept one terminal open watching my files and re-running all tests on any change. </p>
<h2 id="implementation">Implementation</h2>
<p>I&#39;m not going to give an extensive walkthrough of the code. If you are interested, you can <a href="https://github.com/davidxmoody/metalsmith-broken-link-checker/blob/master/src/index.coffee">view the source code here</a>. It&#39;s a relatively concise 93 lines of CoffeeScript (with lots of comments).</p>
<p>Here is a quick overview of what the program does:</p>
<ol>
<li>
<p>Extract all links in HTML pages with <a href="https://github.com/cheeriojs/cheerio">cheerio</a>. Cheerio is basically jQuery for static content and it works very nicely. </p>
</li>
<li>
<p>Determine which file in the Metalsmith pipeline corresponds to each link and throw an error if the file does not exist. This was a bit harder. I spent about an hour going down dead ends with one URL manipulation library and then trying to write my own. I then found <a href="https://www.npmjs.com/package/URIjs">URIjs</a> which worked much better. </p>
</li>
<li>
<p>Provide configuration options. For example, <code>options.warn</code> to print errors to the console instead of throwing them. Also the ability to check <code>src</code> attributes of <code>img</code> tags and the ability to specify a regex of URLs to ignore.</p>
</li>
</ol>
<p>There are also a lot of different edge cases which all add complexity to the program. For example: relative links have to be resolved relative to the file they appear in, hash fragments should be allowed, links to directories containing an <code>index.html</code> should be allowed and so on.</p>
<p>Then of course I had to write the README as well. Writing good documentation can often be the hardest part. In many ways though, it&#39;s just as important as the code itself so I wanted to do it right. I created an example HTML file showing the different types of links that the plugin recognises and what Metalsmith files they correspond to. </p>
<h2 id="npm-tips">Npm tips</h2>
<p>Here is a quick list of a few useful things I&#39;ve learned while using npm:</p>
<ul>
<li>I was using CoffeeScript but wanted to compile to JavaScript before publishing. In my <a href="https://github.com/davidxmoody/metalsmith-broken-link-checker/blob/master/package.json">package.json</a> I have the following prepublish script to do that and also a watch script for development which runs my tests on any change.</li>
</ul>
<pre><code class="lang-json">{
  "<span class="hljs-attribute">scripts</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">watch</span>": <span class="hljs-value"><span class="hljs-string">"coffee --watch -o lib -c src/*.coffee &amp; mocha --watch --compilers coffee:coffee-script/register"</span></span>,
    "<span class="hljs-attribute">test</span>": <span class="hljs-value"><span class="hljs-string">"mocha --compilers coffee:coffee-script/register"</span></span>,
    "<span class="hljs-attribute">prepublish</span>": <span class="hljs-value"><span class="hljs-string">"coffee -o lib -c src/*.coffee"</span>
  </span>}</span>,
}
</code></pre>
<ul>
<li>
<p><code>npm version 0.1.0</code> will set the version number in <code>package.json</code> as well as commit that change to git and then tag that git commit with <code>v0.1.0</code>.</p>
</li>
<li>
<p><code>npm link</code> in my project dir then <code>npm link metalsmith-broken-link-checker</code> in my blog dir to symlink my link checker as a dependency to my blog. Very useful for testing so you don&#39;t have to continuously uninstall and reinstall it.</p>
</li>
<li>
<p><code>.npmignore</code> to prevent tests and CoffeeScript files from being published by npm. Then <code>npm pack</code> to bundle up everything like it would be when it gets published. Useful to see what files are actually going to get published without having to publish them.</p>
</li>
</ul>
<h2 id="publishing-to-npm">Publishing to npm</h2>
<p>Before I published to npm, I first <a href="https://github.com/davidxmoody/metalsmith-broken-link-checker">uploaded it to GitHub</a>. Pretty easy as this was my <em>seventh</em> GitHub repo.</p>
<p>I then signed up for npm (again easy). However, I couldn&#39;t log in with the command line utility. <a href="https://github.com/npm/npm/issues/7876">According to this post</a>, I was using an older version of npm. No problem, I used npm itself to install the newest version of npm (<code>npm install -g npm</code>) and logged in just fine. </p>
<p>I then published version 0.1.0 without any problems.</p>
<h2 id="a-bonus-my-first-ever-pull-request">A bonus: My first ever pull request</h2>
<p>I realised that I should also get my plugin listed on the official <a href="http://www.metalsmith.io/">metalsmith.io</a> website. </p>
<p>I forked the <a href="https://github.com/segmentio/metalsmith.io">metalsmith.io repository on GitHub</a> and cloned it locally. I updated the JSON list of packages, committed, pushed and then submitted my first ever pull request. </p>
<p>Now I&#39;ve done it, it all seems pretty trivial. However, at the time, it felt like a pretty significant achievement. It was the same for my first GitHub repo and my first blog post. I guess it&#39;s just one of those things.</p>
<h2 id="three-weeks-later-">Three weeks later...</h2>
<p>I published the plugin about three weeks ago. </p>
<p>Since then, it&#39;s had 190 downloads on npm and 19 visitors to my GitHub repo. Not too bad. </p>
<p>Was it worth it? This project took me slightly more than a full day to implement. Realistically, the amount of time my plugin will save other people will only barely be worth the amount of time it took me. </p>
<p>But in terms of <em>my experience</em>, it has been worth it a hundred times over. </p>
<p>The idea of creating a useful open source project used to feel like a significant milestone for me. Now I&#39;ve done it once, I feel like I could do it again in half the time. I feel like this was only the first step on my road to becoming an open source contributor. </p>
</div>
</article>
</div>

<div class="push"></div>
</div>

<footer class="site-footer">
<br>
<p>
<a href="/feed.xml">RSS</a> |
<a href="https://github.com/davidxmoody">GitHub</a> |
<a href="mailto:david@davidxmoody.com">Email</a>
</p>
<p>
This blog is available under a
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
        Creative Commons License
      </a>
</p>
</footer>

<script>
(function(i, s, o, g, r, a, m) {
				i['GoogleAnalyticsObject'] = r;
				i[r] = i[r] || function() {
								(i[r].q = i[r].q || []).push(arguments)
				}, i[r].l = 1 * new Date();
				a = s.createElement(o),
								m = s.getElementsByTagName(o)[0];
				a.async = 1;
				a.src = g;
				m.parentNode.insertBefore(a, m)
})(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-54505873-1', 'auto');
ga('send', 'pageview');
</script>

</body>

</html>