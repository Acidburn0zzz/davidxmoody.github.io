<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Building a blog with Metalsmith</title>
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="I recently transitioned this blog from Jekyll to Metalsmith. I&#39;m glad I started with Jekyll but I wanted more control. I decided to switch to...">
  <link rel="canonical" href="https://davidxmoody.com/building-a-blog-with-metalsmith/">
  <link rel="stylesheet" href="/css/main-a224372f29b28b5918ba7d3053ef3cc9.css">
  <meta name="wot-verification" content="fdff4a26070b9df2fd1a"/>
</head>
<body>

  <div class="wrapper">
    <header class="site-header">
      <h1><a href="/">David Moody</a></h1>
      <p>A blog about programming</p>
    </header>

    <div class="content">
      
  <article>
    <header>
      <h1>Building a blog with Metalsmith</h1>
      <p><em>Feb 11, 2015</em></p>
    </header>

    <p>I recently transitioned this blog from <a href="http://jekyllrb.com/">Jekyll</a> to <a href="http://www.metalsmith.io/">Metalsmith</a>. I&#39;m glad I started with Jekyll but I wanted more control. I decided to switch to Metalsmith so that I could write my own build scripts in a language I knew (JavaScript). </p>
<p>There are <em>tons</em> of excellent static site generators available. See <a href="https://staticsitegenerators.net/">staticsitegenerators.net</a> for a list. I&#39;ve used <a href="https://docpad.org/">DocPad</a> before (for the <a href="http://professorp.co.uk/">professorp.co.uk</a> website). I chose Metalsmith because it offered the most bare-bones setup with minimal restrictions. </p>
<p>This post will not be a full guide on how to use Metalsmith. I&#39;m assuming that anyone interested in Metalsmith is willing to get their hands dirty. Instead, this post will simply list some of the useful plugins I&#39;ve come across and some other hacks I&#39;ve made up. </p>
<!--more-->
<h2 id="paragraph-count">Paragraph count</h2>
<p>In one of my very early posts, I wrote about <a href="/paragraph-counts-in-jekyll/">paragraph counts in Jekyll</a>. I like to have links saying <em>&quot;Read 15 remaining paragraphs...&quot;</em> at the end of my excerpts. I think it&#39;s better than not giving any information on the length of an article and more useful than giving a raw wordcount. </p>
<p>Jekyll was rather limited in how it could count paragraphs. I ended up using a pretty awkward Liquid Template hack. Thankfully JavaScript can do much better. Everything after the <code>&lt;!--more--&gt;</code> tag is passed through the <code>paraCount()</code>  function. It counts everything I feel qualifies as a paragraph including: <code>&lt;p&gt;</code>, <code>&lt;ul&gt;</code>, <code>&lt;ol&gt;</code>, <code>&lt;pre&gt;</code> and <code>&lt;table&gt;</code> elements.</p>
<pre><code class="lang-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">paraCount</span>(<span class="hljs-params">text</span>) </span>{
  <span class="hljs-keyword">return</span> text.match(<span class="hljs-regexp">/&lt;(p|ul|ol|pre|table)&gt;[\s\S]*?&lt;\/\1&gt;/g</span>).length;
}
</code></pre>
<h2 id="post-organisation">Post organisation</h2>
<p>I keep all my posts in pretty much the same format as I used with Jekyll. For example:</p>
<pre><code class="lang-bash">src/posts/2014-08-11-hello-world.md
</code></pre>
<p>I use the handy <a href="https://github.com/sanx/metalsmith-date-in-filename">metalsmith-date-in-filename</a> plugin to extract the dates. I also use the <a href="https://github.com/segmentio/metalsmith-permalinks">metalsmith-permalinks</a> and <a href="https://github.com/segmentio/metalsmith-collections">metalsmith-collections</a> plugins rename and organise posts.</p>
<h2 id="rss-feed">RSS feed</h2>
<p>There&#39;s a very handy <a href="https://github.com/hurrymaplelad/metalsmith-feed">metalsmith-feed</a> plugin for generating RSS feeds from collections. </p>
<p>It works great although I like to substitute all relative URLs with absolute ones so that they work correctly when viewed in an RSS reader:</p>
<pre><code class="lang-js">  .use(feed({
    collection: <span class="hljs-string">'posts'</span>,
    limit: <span class="hljs-number">10</span>,
    destination: <span class="hljs-string">'feed.xml'</span>
  }))
  .use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">files</span>) </span>{
    data = files[<span class="hljs-string">'feed.xml'</span>];
    data.contents = <span class="hljs-keyword">new</span> Buffer(data.contents.toString()
        .replace(<span class="hljs-regexp">/(src|href)="\//g</span>, <span class="hljs-string">'$1="https://davidxmoody.com/'</span>));
  })
</code></pre>
<h2 id="markdown-and-pygments">Markdown and Pygments</h2>
<p>Jekyll uses <a href="http://pygments.org/">Pygments</a>, a syntax highlighter written in Python. It&#39;s pretty good and has support for tons of languages. It also supports the <code>console</code> language for mixing in bash prompts with output from commands. I use that in several of my older posts and didn&#39;t want to lose it. </p>
<p>I spent <em>far too long</em> hacking together my own Markdown plugin which could do syntax highlighting with Pygments. I ran into a lot of problems with marked and Pygments. The complications arise because Pygments is an external Python library and thus has to be called asynchronously. Marked <em>does</em> support this. However, it was tricky to tie it all together. Additionally, both marked and Pygments add in a <code>&lt;pre&gt;</code> element wrapping the code and I had to hack together a way to get around having two <code>&lt;pre&gt;</code> elements at once.</p>
<p>This blog is currently using Pygments but I regret it. It wasn&#39;t worth the effort. I&#39;m even considering going back to <a href="https://highlightjs.org/">highlight.js</a> for the simplicity and speed improvement.</p>
<p>If you are dead set on using Pygments with Metalsmith then you might want to refer to <a href="https://github.com/davidxmoody/davidxmoody.github.io/blob/f79f9e9088612d5c0c6840268f1bdfb06accd53b/scripts/markdown.js">this file</a>. It is a modified version of the <a href="https://github.com/segmentio/metalsmith-markdown">metalsmith-markdown</a> plugin which handles asynchronous Pygments highlighting. </p>
<h2 id="misc">Misc</h2>
<ul>
<li><a href="https://github.com/wilsaj/metalsmith-each">metalsmith-each</a> and <a href="https://github.com/segmentio/metalsmith-ignore">metalsmith-ignore</a> are pretty useful</li>
<li>I&#39;ve written about <a href="/cloudflare-and-hashed-css/">CSS file hashing</a> in a previous post with the <a href="https://github.com/christophercliff/metalsmith-fingerprint">metalsmith-fingerprint</a> plugin</li>
<li>I have implemented a basic pagination setup and basic archive page, I plan on doing a better job and writing a full post on them later</li>
<li><a href="https://github.com/mayo/metalsmith-serve">metalsmith-serve</a> is a quick and convenient way to serve your site when testing</li>
<li>Unfortunately metalsmith-serve doesn&#39;t work with <a href="https://github.com/FWeinb/metalsmith-watch">metalsmith-watch</a> so I use <a href="https://github.com/remy/nodemon">nodemon</a> to watch for changes and rebuild the site</li>
<li>I switched from Liquid Templates to <a href="http://handlebarsjs.com/">Handlebars</a></li>
</ul>
<h2 id="final-thoughts">Final thoughts</h2>
<p>Overall, Metalsmith is great. It&#39;s <em>supposed</em> to be extremely simple and rely on plugins to do the heavy lifting. It accomplishes that well. I would happily use it for another project.</p>
<p>My only complaint is that it doesn&#39;t do incremental builds. A small change in one post causes a full rebuild with my current setup. It&#39;s understandable why Metalsmith doesn&#39;t include this (it would be really complex). I may try to implement a custom solution where each individual post is only updated when that post changes but all other files are regenerated every time. </p>
<p><em>[Edit: I recently created created and published my first Metalsmith plugin. It&#39;s a plugin to check files for internal broken links. See <a href="/publishing-my-first-npm-package/">this blog post</a> for how I did it or go straight to the <a href="https://www.npmjs.com/package/metalsmith-broken-link-checker">npm package</a>.]</em></p>

  </article>

    </div>
    
    <div class="push"></div>
  </div>

  <footer class="site-footer">
    <br>
    <p>
      <a href="/feed.xml">RSS</a> | 
      <a href="https://github.com/davidxmoody">GitHub</a> | 
      <a href="mailto:david@davidxmoody.com">Email</a>
    </p>
    <p>
      This blog is available under a 
      <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
        Creative Commons License
      </a>
    </p>
  </footer>

  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-54505873-1', 'auto');
    ga('send', 'pageview');
  </script>
  

</body>
</html>
